---
# generate_certificates.yml

# --- Préparer les dossiers ipsec.d ---
- name: Ensure ipsec.d directories exist
  file:
    path: "/etc/ipsec.d/{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - private
    - certs
    - reqs
    - cacerts

# --- Copier le certificat CA ---
- name: Copy CA certificate to /etc/ipsec.d/cacerts
  copy:
    src: "{{ ca_crt }}"
    dest: /etc/ipsec.d/cacerts/cacert.pem
    remote_src: true

# --- Génération du certificat serveur ---
- name: Generate server private key
  command: openssl genrsa -out "{{ server_key }}" 4096
  args:
    creates: "{{ server_key }}"

- name: Render OpenSSL config for server
  template:
    src: openssl.cnf.j2
    dest: /etc/ipsec.d/reqs/openssl-server.cnf
  vars:
    cn_name: "{{ server_cn }}"
    san_dns: "{{ server_cn }}"
    san_ip: "{{ server_ip | default('127.0.0.1') }}"

- name: Generate server CSR
  command: >
    openssl req -new -key "{{ server_key }}"
    -out "{{ server_csr }}"
    -config /etc/ipsec.d/reqs/openssl-server.cnf
  args:
    creates: "{{ server_csr }}"

- name: Sign server certificate
  command: >
    openssl x509 -req -in "{{ server_csr }}"
    -CA "{{ ca_crt }}" -CAkey "{{ ca_key }}" -CAcreateserial
    -out "{{ server_crt }}"
    -days {{ days_srv }} -sha256
    -extensions v3_req
    -extfile /etc/ipsec.d/reqs/openssl-server.cnf
  args:
    creates: "{{ server_crt }}"

# --- Génération des certificats clients ---
- name: Generate client certificates
  include_tasks: generate_client.yml
  loop: "{{ clients }}"
  loop_control:
    loop_var: client
